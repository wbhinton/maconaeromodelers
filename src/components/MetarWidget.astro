---
// src/components/MetarWidget.astro
---

<div id="weather-widget" class="bg-white rounded-xl shadow-md border border-gray-200 p-6 max-w-4xl mx-auto -mt-8 relative z-10 hidden">
  <div class="flex flex-col md:flex-row items-center justify-between gap-6">
    
    <div class="flex items-center gap-4">
      <div class="bg-blue-100 p-3 rounded-full text-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
        </svg>
      </div>
      <div>
        <h3 class="text-lg font-bold text-gray-800">Current Field Conditions</h3>
        <p class="text-sm text-gray-500">Franklin (K1A5) • <span id="metar-time">Loading...</span></p>
      </div>
    </div>

    <div class="flex flex-wrap gap-4 md:gap-8 justify-center text-center">
      
      <div class="bg-gray-50 px-6 py-3 rounded-lg border border-gray-100 min-w-[120px]">
        <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Wind</p>
        <p id="metar-wind" class="text-xl font-bold text-primary">--</p>
      </div>

      <div class="bg-gray-50 px-6 py-3 rounded-lg border border-gray-100 min-w-[120px]">
        <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Sky</p>
        <p id="metar-sky" class="text-xl font-bold text-primary">--</p>
      </div>

      <div class="bg-gray-50 px-6 py-3 rounded-lg border border-gray-100 min-w-[120px]">
        <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Temp</p>
        <p id="metar-temp" class="text-xl font-bold text-primary">--</p>
      </div>

    </div>
  </div>
</div>

<script is:inline>
  async function fetchWeather() {
    const widget = document.getElementById('weather-widget');
    
    try {
      // FIX: Route through a CORS Proxy
      // We take the NOAA URL and wrap it with corsproxy.io
      // This adds the headers your browser requires.
      const noaaUrl = `https://tgftp.nws.noaa.gov/data/observations/metar/stations/K1A5.TXT?cb=${Date.now()}`;
      const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(noaaUrl)}`;
      
      const response = await fetch(proxyUrl);
      
      if (!response.ok) throw new Error('Weather source failed');
      
      const rawText = await response.text();
      
      // NOAA file format:
      // Line 1: 2025/12/13 14:00
      // Line 2: K1A5 131400Z ...
      
      if (rawText && rawText.includes('K1A5')) {
        widget.classList.remove('hidden');
        parseMetar(rawText);
      }

    } catch (e) {
      console.error("Weather widget error:", e);
    }
  }

  function parseMetar(text) {
    // 1. Clean the text: Split by lines and find the one with the METAR data
    const lines = text.split('\n');
    const metarLine = lines.find(line => line.includes('K1A5'));
    
    if (!metarLine) return;

    const metar = metarLine.trim();

    // --- Time ---
    const timeMatch = metar.match(/\d{6}Z/);
    if (timeMatch) {
      document.getElementById('metar-time').textContent = `Reported ${timeMatch[0]}`;
    } else {
      document.getElementById('metar-time').textContent = 'Recent Report';
    }

    // --- Wind ---
    const windRegex = /(\d{3}|VRB)(\d{2,3})(G(\d{2,3}))?KT/;
    const windMatch = metar.match(windRegex);
    
    if (windMatch) {
      const direction = windMatch[1];
      const speed = parseInt(windMatch[2], 10);
      const gust = windMatch[4] ? `, Gusts ${windMatch[4]}` : '';
      
      let windText = "";
      if (speed === 0) {
        windText = "Calm";
      } else {
        windText = `${direction}° @ ${speed}kts${gust}`;
      }
      document.getElementById('metar-wind').textContent = windText;
    }

    // --- Temp ---
    const tempRegex = /(M?\d{2})\/(M?\d{2})/;
    const tempMatch = metar.match(tempRegex);
    
    if (tempMatch) {
      let tempC = parseInt(tempMatch[1].replace('M', '-'), 10); 
      let tempF = Math.round((tempC * 9/5) + 32);
      document.getElementById('metar-temp').textContent = `${tempF}°F (${tempC}°C)`;
    }

    // --- Sky ---
    const skyConditions = ['CLR', 'SKC', 'FEW', 'SCT', 'BKN', 'OVC'];
    let foundSky = "Clear";
    
    for (const cond of skyConditions) {
      if (metar.includes(cond)) {
        if (cond === 'CLR' || cond === 'SKC') foundSky = "Clear";
        if (cond === 'FEW') foundSky = "Few Clouds";
        if (cond === 'SCT') foundSky = "Scattered";
        if (cond === 'BKN') foundSky = "Broken Clouds";
        if (cond === 'OVC') foundSky = "Overcast";
        break; 
      }
    }
    document.getElementById('metar-sky').textContent = foundSky;
  }

  document.addEventListener('DOMContentLoaded', fetchWeather);
</script>
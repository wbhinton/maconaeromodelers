---
// src/components/FieldWeather.astro
---
<div id="weather-dashboard" class="bg-white rounded-xl shadow-md border border-gray-200 p-6 max-w-5xl mx-auto -mt-12 relative z-10 hidden">
  
  <div class="flex flex-col md:flex-row items-center justify-between border-b border-gray-100 pb-4 mb-6 gap-4">
    <div class="flex items-center gap-4">
      <div class="bg-gradient-to-br from-primary to-blue-600 p-3 rounded-full text-white shadow-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
      </div>
      <div>
        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
          <a 
            href="https://ambientweather.net/dashboard/2ae669e5daebf0249f2771df7bcef9d3" 
            target="_blank" 
            rel="noopener noreferrer" 
            class="hover:text-primary transition-colors flex items-center gap-2"
            title="View Full Weather Dashboard"
          >
            Field Conditions
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 hover:text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </a>
        </h3>
        <div class="flex flex-col sm:flex-row sm:gap-4 text-sm text-gray-500">
          <span id="pws-status">Station: Waiting...</span>
          <span class="hidden sm:inline">•</span>
          <span id="metar-status">Airport: Waiting...</span>
        </div>
      </div>
    </div>
    
    <div id="flight-category" class="hidden px-4 py-1 rounded-full text-sm font-bold bg-gray-100 text-gray-500">
      LOADING
    </div>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
    
    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
      <p class="text-xs text-blue-600 uppercase tracking-wider font-bold mb-1">Wind (OTX)</p>
      <p id="val-wind" class="text-2xl font-bold text-gray-900">--</p>
      <p id="val-wind-dir" class="text-xs text-gray-500 mt-1">--</p>
    </div>

    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
      <p class="text-xs text-orange-600 uppercase tracking-wider font-bold mb-1">Gusts (OTX)</p>
      <p id="val-gust" class="text-2xl font-bold text-gray-900">--</p>
      <p class="text-xs text-gray-500 mt-1">MPH</p>
    </div>

    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
      <p class="text-xs text-gray-500 uppercase tracking-wider font-bold mb-1">Sky (K1A5)</p>
      <p id="val-sky" class="text-xl font-bold text-gray-900 mt-1">--</p>
      <p id="val-vis" class="text-xs text-gray-500 mt-1">--</p>
    </div>

    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
      <p class="text-xs text-gray-500 uppercase tracking-wider font-bold mb-1">Temp (OTX)</p>
      <p id="val-temp" class="text-2xl font-bold text-gray-900">--</p>
      <p id="val-feels" class="text-xs text-gray-500 mt-1">--</p>
    </div>

  </div>
</div>

<script is:inline>
  // ==========================================
  // CONFIGURATION
  // ==========================================
  // PASTE YOUR CLOUDFLARE WORKER URL HERE:
  const PROXY_URL = 'https://spring-bread-84bd.wbhinton.workers.dev/'; 
  const METAR_ID = 'K1A5';
  // ==========================================

  // FIX: Declare 'ui' empty first. We fill it only when the DOM is ready.
  let ui = {};

  async function initDashboard() {
    // Check config
    if (PROXY_URL.includes('PLACEHOLDER')) {
      console.error("Please update PROXY_URL in FieldWeather.astro with your Cloudflare Worker URL.");
      return;
    }

    // FIX: Initialize UI references NOW (inside the function)
    ui = {
      container: document.getElementById('weather-dashboard'),
      wind: document.getElementById('val-wind'),
      windDir: document.getElementById('val-wind-dir'),
      gust: document.getElementById('val-gust'),
      temp: document.getElementById('val-temp'),
      feels: document.getElementById('val-feels'),
      sky: document.getElementById('val-sky'),
      vis: document.getElementById('val-vis'),
      cat: document.getElementById('flight-category'),
      statusPws: document.getElementById('pws-status'),
      statusMetar: document.getElementById('metar-status')
    };

    // FIX: Safety check - If the HTML isn't there, stop to prevent the error
    if (!ui.container) {
      console.warn("Weather Dashboard HTML not found.");
      return;
    }

    // Reveal widget
    ui.container.classList.remove('hidden');

    // Run fetches
    Promise.allSettled([fetchLocalStation(), fetchAirportMetar()]);
  }

  // ------------------------------------------------------
  // SOURCE 1: Local Station (Via Cloudflare Proxy)
  // ------------------------------------------------------
  async function fetchLocalStation() {
    try {
      const res = await fetch(PROXY_URL);
      if (!res.ok) throw new Error('PWS Offline');
      const data = await res.json();
      
      if (!data.observations || data.observations.length === 0) throw new Error('No Data');
      const obs = data.observations[0];

      // Update UI
      const speed = obs.imperial.windSpeed;
      const gust = obs.imperial.windGust;
      const dir = obs.winddir;
      
      if (ui.wind) ui.wind.textContent = speed === 0 ? "Calm" : `${speed} mph`;
      if (ui.windDir) ui.windDir.textContent = speed === 0 ? "No wind" : `From ${dir}° (${getCardinal(dir)})`;
      if (ui.gust) ui.gust.textContent = gust;
      
      // Colorize Gusts
      if (gust > 15 && ui.gust) {
        ui.gust.parentElement.classList.remove('bg-orange-50', 'border-orange-100');
        ui.gust.parentElement.classList.add('bg-red-50', 'border-red-200');
        ui.gust.classList.add('text-red-600');
      }

      if (ui.temp) ui.temp.textContent = `${obs.imperial.temp}°F`;
      if (ui.feels) ui.feels.textContent = `Feels like ${obs.imperial.windChill}°`;

      const time = new Date(obs.obsTimeLocal).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      if (ui.statusPws) {
        ui.statusPws.textContent = `Field: ${time}`;
        ui.statusPws.classList.add('text-green-600', 'font-medium');
      }

    } catch (e) {
      console.error("Station Error:", e);
      if (ui.statusPws) {
        ui.statusPws.textContent = "Field Station: Offline";
        ui.statusPws.classList.add('text-red-500');
      }
    }
  }

  // ------------------------------------------------------
  // SOURCE 2: Airport METAR (Sky, Vis, Category)
  // ------------------------------------------------------
  async function fetchAirportMetar() {
    try {
      // Fetches through our Cloudflare Worker which adds CORS headers
      const res = await fetch(`${PROXY_URL}metar?id=${METAR_ID}`);
      if (!res.ok) throw new Error('METAR Offline');
      const text = await res.text();
      if (!text || !text.includes(METAR_ID)) throw new Error('Parse Fail');

      // AWC returns "METAR K1A5 ..." — use the full text as the metar string
      const metar = text.trim();

      let skyText = "Clear";
      if (metar.includes('OVC')) skyText = "Overcast";
      else if (metar.includes('BKN')) skyText = "Broken Clouds";
      else if (metar.includes('SCT')) skyText = "Scattered";
      else if (metar.includes('FEW')) skyText = "Few Clouds";
      if (ui.sky) ui.sky.textContent = skyText;

      const visMatch = metar.match(/\s(\d+SM)/);
      if (visMatch && ui.vis) {
        ui.vis.textContent = `Visibility: ${visMatch[1]}`;
      }

      const isVFR = !metar.includes('OVC00') && !metar.includes('BKN00') && (visMatch ? parseInt(visMatch[1]) > 3 : true);
      
      if (ui.cat) {
        ui.cat.textContent = isVFR ? "VFR (Good to Fly)" : "Review Conditions";
        ui.cat.className = isVFR 
          ? "px-4 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200"
          : "px-4 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700 border border-yellow-200";
        ui.cat.classList.remove('hidden');
      }

      if (ui.statusMetar) ui.statusMetar.textContent = `Airport (${METAR_ID}): Online`;

    } catch (e) {
      console.error("METAR Error:", e);
      if (ui.statusMetar) ui.statusMetar.textContent = "Airport Data: Unavailable";
      if (ui.sky) ui.sky.textContent = "--";
    }
  }

  function getCardinal(angle) {
    const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
    return directions[Math.round(angle / 45) % 8];
  }

  // Ensure this runs when the HTML is ready
  document.addEventListener('DOMContentLoaded', initDashboard);
  // Also run on Astro View Transitions (if enabled)
  document.addEventListener('astro:page-load', initDashboard);
</script>
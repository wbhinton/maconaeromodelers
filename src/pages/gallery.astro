---
import Layout from '../layouts/Layout.astro';
import { Image, getImage } from 'astro:assets';

// 1. Get and Process Images
const allImages = import.meta.glob('../assets/gallery/**/*.{jpeg,jpg,png,webp}', { eager: true });
const albums: Record<string, any[]> = {};

await Promise.all(Object.keys(allImages).map(async (path) => {
  const parts = path.split('/');
  const folderName = parts[parts.length - 2]; 
  const imageModule = (allImages[path] as any).default;

  if (!albums[folderName]) {
    albums[folderName] = [];
  }

  const optimizedImage = await getImage({
    src: imageModule,
    format: 'webp',
    width: 1920,
  });

  albums[folderName].push({
    thumb: imageModule,
    fullRes: optimizedImage.src
  });
}));

const sortedAlbumKeys = Object.keys(albums).sort().reverse();
const formatTitle = (name: string) => name.replace(/-/g, ' ');

// 2. Video Configuration
const videos = [
  { id: "dQw4w9WgXcQ", title: "Club Fly-In Highlights 2024" }, 
  { id: "LXb3EKWsInQ", title: "Scale Warbird Flight" },         
  { id: "jNQXAC9IVRw", title: "Learning to Fly at Macon" },     
];
---

<Layout title="Gallery">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.3/simple-lightbox.min.css" />

  <div class="max-w-7xl mx-auto px-4 py-12">
    
    <div class="text-center max-w-3xl mx-auto mb-12">
      <h1 class="text-4xl font-bold text-primary mb-4">Club Gallery</h1>
      <p class="text-xl text-gray-600">
        Moments from our fly-ins, build nights, and field days.
      </p>
    </div>

    <div class="mb-20 max-w-5xl mx-auto">
      <div class="flex items-center gap-4 mb-6">
        <div class="h-8 w-1 bg-primary rounded-full"></div>
        <h2 class="text-3xl font-bold text-gray-800">Event Photos</h2>
      </div>

      <div class="space-y-4">
        {sortedAlbumKeys.map((albumName, index) => (
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            
            <button 
              class="accordion-trigger w-full flex items-center justify-between p-6 text-left hover:bg-gray-50 transition-colors focus:outline-none group"
              data-target={`album-${index}`}
              aria-expanded={index === 0 ? "true" : "false"}
            >
              <div class="flex items-center gap-4">
                <div class="bg-blue-100 text-primary p-2 rounded-lg">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
                <div>
                  <h3 class="text-xl font-bold text-gray-800 capitalize group-hover:text-primary transition-colors">
                    {formatTitle(albumName)}
                  </h3>
                  <p class="text-sm text-gray-500">{albums[albumName].length} photos</p>
                </div>
              </div>

              <svg 
                id={`icon-album-${index}`}
                xmlns="http://www.w3.org/2000/svg" 
                class={`icon-chevron h-6 w-6 text-gray-400 transform transition-transform duration-300 ${index === 0 ? 'rotate-180' : ''}`}
                fill="none" 
                viewBox="0 0 24 24" 
                stroke="currentColor"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>

            <div 
              id={`album-${index}`} 
              class={`accordion-content border-t border-gray-100 bg-gray-50 p-6 ${index === 0 ? '' : 'hidden'}`}
            >
              <div class="gallery-container grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {albums[albumName].map((photo) => (
                  <a 
                    href={photo.fullRes} 
                    class="block overflow-hidden rounded-lg shadow-sm hover:shadow-md transition-shadow bg-gray-200 aspect-[4/3]"
                  >
                    <Image 
                      src={photo.thumb} 
                      alt={`${albumName} photo`} 
                      width={400} 
                      height={300}
                      class="w-full h-full object-cover hover:scale-105 transition-transform duration-500"
                    />
                  </a>
                ))}
              </div>
            </div>

          </div>
        ))}
      </div>

      {sortedAlbumKeys.length === 0 && (
        <div class="text-center py-12 bg-gray-50 rounded-xl border border-dashed border-gray-300">
          <p class="text-gray-500">No photos found. Add folders to <code>src/assets/gallery/</code>.</p>
        </div>
      )}
    </div>

    <section class="max-w-7xl mx-auto border-t border-gray-200 pt-16">
      <div class="flex items-center justify-between gap-4 mb-8">
        <div class="flex items-center gap-4">
          <div class="h-8 w-1 bg-primary rounded-full"></div>
          <h2 class="text-3xl font-bold text-gray-800">Flight Videos</h2>
        </div>
        
        <a 
          href="https://www.youtube.com/channel/UCy5OGJfxp4gos5WnEADppSw" 
          target="_blank"
          class="hidden sm:flex items-center gap-2 text-red-600 font-bold hover:text-red-700 transition-colors"
        >
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
          View Channel
        </a>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {videos.map((video) => (
          <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden hover:-translate-y-1 transition-transform duration-300">
            <div class="aspect-video w-full bg-gray-900">
              <iframe 
                width="100%" 
                height="100%" 
                src={`https://www.youtube.com/embed/${video.id}`} 
                title={video.title}
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen
              ></iframe>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-gray-800 line-clamp-2">{video.title}</h3>
            </div>
          </div>
        ))}
      </div>
      
      <div class="mt-8 text-center sm:hidden">
        <a 
          href="https://www.youtube.com/channel/UCy5OGJfxp4gos5WnEADppSw" 
          target="_blank"
          class="inline-flex items-center gap-2 text-red-600 font-bold"
        >
          View More on YouTube &rarr;
        </a>
      </div>
    </section>

  </div>
</Layout>

<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.3/simple-lightbox.min.js"></script>

<script is:inline>
  function setupGallery() {
    // 1. Setup Accordion Listeners
    // We select all buttons with class 'accordion-trigger'
    const triggers = document.querySelectorAll('.accordion-trigger');
    
    triggers.forEach(button => {
      // Remove old listeners to prevent duplicates if function runs twice
      button.removeEventListener('click', handleAccordionClick);
      // Add new listener
      button.addEventListener('click', handleAccordionClick);
    });

    // 2. Setup Lightbox
    if (typeof SimpleLightbox !== 'undefined') {
      // Destroy old instance if exists (prevents bugs on navigation)
      if (window.lightboxInstance) window.lightboxInstance.destroy();
      
      window.lightboxInstance = new SimpleLightbox('.gallery-container a', {
          captions: true,
          captionDelay: 250,
          animationSpeed: 250,
          fadeSpeed: 250,
          showCounter: true,
          loop: true,
          close: true,
          fileExt: false
      });
    }
  }

  function handleAccordionClick(e) {
    // Find the button (it might be the clicked element or a parent of the clicked element)
    const button = e.currentTarget;
    const targetId = button.getAttribute('data-target');
    const content = document.getElementById(targetId);
    
    // Find the icon inside this button
    const icon = button.querySelector('.icon-chevron');

    if (content) {
      content.classList.toggle('hidden');
      
      // Rotate Icon
      if (content.classList.contains('hidden')) {
        icon.classList.remove('rotate-180');
        button.setAttribute('aria-expanded', 'false');
      } else {
        icon.classList.add('rotate-180');
        button.setAttribute('aria-expanded', 'true');
      }
    }
  }

  // Run on initial load
  document.addEventListener('DOMContentLoaded', setupGallery);
  // Run on view transitions (if you navigate away and back)
  document.addEventListener('astro:page-load', setupGallery);
</script>

<style is:global>
  .sl-wrapper { z-index: 9999 !important; }
  .sl-overlay { z-index: 9998 !important; background: #0f172a !important; }
  .sl-wrapper .sl-close, .sl-wrapper .sl-navigation button, .sl-wrapper .sl-counter { color: #ffffff !important; }
  .sl-wrapper .sl-close:hover, .sl-wrapper .sl-navigation button:hover { color: #f59e0b !important; }
  .sl-spinner { border-color: #ffffff !important; }
</style>
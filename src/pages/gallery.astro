---
import Layout from '../layouts/Layout.astro';
import { Image, getImage } from 'astro:assets';

// 1. Get and Process Images
const allImages = import.meta.glob('../assets/gallery/**/*.{jpeg,jpg,png,webp}', { eager: true });
const albums: Record<string, any[]> = {};

await Promise.all(Object.keys(allImages).map(async (path) => {
  const parts = path.split('/');
  const folderName = parts[parts.length - 2]; 
  const imageModule = (allImages[path] as any).default;

  if (!albums[folderName]) {
    albums[folderName] = [];
  }

  const optimizedImage = await getImage({
    src: imageModule,
    format: 'webp',
    width: 1920,
  });

  albums[folderName].push({
    thumb: imageModule,
    fullRes: optimizedImage.src
  });
}));

const sortedAlbumKeys = Object.keys(albums).sort().reverse();
const formatTitle = (name: string) => name.replace(/-/g, ' ');
---

<Layout title="Club Photo Gallery">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.3/simple-lightbox.min.css" />

  <div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-primary mb-4">Event Galleries</h1>
    <p class="text-gray-600 mb-12">Photos from our recent fly-ins, build nights, and field work days.</p>

    {sortedAlbumKeys.map((albumName) => (
      <div class="mb-16">
        <div class="flex items-center gap-4 mb-6 border-b border-gray-200 pb-2">
          <h2 class="text-2xl font-bold text-text-dark capitalize">
            {formatTitle(albumName)}
          </h2>
          <span class="text-sm text-gray-400 bg-gray-100 px-2 py-1 rounded-full">
            {albums[albumName].length} photos
          </span>
        </div>

        <div class="gallery-container grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {albums[albumName].map((photo) => (
            <a 
              href={photo.fullRes} 
              class="block overflow-hidden rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 bg-gray-100"
            >
              <Image 
                src={photo.thumb} 
                alt={`${albumName} photo`} 
                width={400} 
                height={300}
                class="w-full h-64 object-cover hover:scale-105 transition-transform duration-500"
              />
            </a>
          ))}
        </div>
      </div>
    ))}

    {sortedAlbumKeys.length === 0 && (
      <div class="text-center py-20 bg-gray-50 rounded-lg">
        <p class="text-gray-500 text-lg">No photos found in <code>src/assets/gallery/</code></p>
      </div>
    )}
  </div>
</Layout>

<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.3/simple-lightbox.min.js"></script>

<script is:inline>
  function initGallery() {
    if (typeof SimpleLightbox !== 'undefined') {
      new SimpleLightbox('.gallery-container a', {
          captions: true,
          captionDelay: 250,
          animationSpeed: 250,
          fadeSpeed: 250,
          showCounter: true,
          loop: true,
          close: true,
          fileExt: false
      });
      console.log('Gallery initialized.');
    }
  }

  document.addEventListener('DOMContentLoaded', initGallery);
  document.addEventListener('astro:page-load', initGallery);
</script>

<style is:global>
  /* 1. Z-Index and Background Overlay */
  .sl-wrapper {
    z-index: 9999 !important;
  }
  .sl-overlay {
    z-index: 9998 !important;
    background: #0f172a !important; /* Dark Slate Background */
  }

  /* 2. Controls Default Color (White) */
  .sl-wrapper .sl-close,
  .sl-wrapper .sl-navigation button,
  .sl-wrapper .sl-counter {
    color: #ffffff !important;
  }

  /* 3. Hover Effect: Use Amber Alert Color (#f59e0b) */
  .sl-wrapper .sl-close:hover,
  .sl-wrapper .sl-navigation button:hover {
    color: #f59e0b !important; /* Amber-500 */
  }

  .sl-spinner {
    border-color: #ffffff !important;
  }
</style>
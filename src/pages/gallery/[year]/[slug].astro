---
import Layout from '../../../layouts/Layout.astro';
import GalleryNav from '../../../components/GalleryNav.astro';
import fs from 'node:fs';
import path from 'node:path';

// 1. Define Types
interface EventMeta {
  title: string;
  date: string;
  description: string;
  cover: string;
}

interface EventPath {
  params: { year: string; slug: string };
  props: { 
    meta: EventMeta;
    images: string[];
    basePath: string;
  };
}

// ==================================================================
// 1. GET STATIC PATHS
// ==================================================================
export async function getStaticPaths() {
  const baseDir = path.join(process.cwd(), 'public', 'assets', 'gallery');
  let paths: EventPath[] = [];

  if (fs.existsSync(baseDir)) {
    const years = fs.readdirSync(baseDir).filter(f => fs.statSync(path.join(baseDir, f)).isDirectory());
    
    years.forEach(year => {
      const yearPath = path.join(baseDir, year);
      const events = fs.readdirSync(yearPath).filter(f => fs.statSync(path.join(yearPath, f)).isDirectory());

      events.forEach(eventSlug => {
        const eventPath = path.join(yearPath, eventSlug);
        let meta: EventMeta = { title: eventSlug, date: year, description: "", cover: "" };
        try {
          const jsonPath = path.join(eventPath, 'info.json');
          if (fs.existsSync(jsonPath)) {
            meta = JSON.parse(fs.readFileSync(jsonPath, 'utf-8'));
          }
        } catch (e) {
          console.error(`Error reading info.json for ${eventSlug}`, e);
        }

        const files = fs.readdirSync(eventPath).filter(f => /\.(jpg|jpeg|png|webp)$/i.test(f));
        
        paths.push({
          params: { year: year, slug: eventSlug },
          props: { 
            meta, 
            images: files,
            basePath: `/assets/gallery/${year}/${eventSlug}/` 
          }
        });
      });
    });
  }
  return paths;
}

// ==================================================================
// 2. THE PAGE TEMPLATE
// ==================================================================
const { meta, images, basePath } = Astro.props;
const fixPath = (filename: string) => `${import.meta.env.BASE_URL}${basePath.replace(/^\//, '')}${filename}`;
---

<Layout title={`${meta.title} - Gallery`}>
  
  <div class="relative bg-gray-900 text-white py-16 px-4 rounded-b-3xl md:rounded-2xl mb-12 shadow-xl overflow-hidden">
    <div class="absolute inset-0 z-0">
      <img 
        src={`${import.meta.env.BASE_URL}assets/images/hero3.jpg`} 
        alt="Gallery" 
        class="w-full h-full object-cover opacity-30" 
      />
      <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent"></div>
    </div>
    <div class="relative z-10 text-center max-w-4xl mx-auto mt-4">
      <h1 class="text-3xl md:text-5xl font-bold mb-2 drop-shadow-lg">{meta.title}</h1>
      <p class="text-lg text-gray-300 drop-shadow-md">{meta.date}</p>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 py-8 mb-16">
    <GalleryNav />

    {meta.description && (
      <div class="bg-gray-50 border-l-4 border-primary p-6 rounded-r-lg mb-12 max-w-4xl">
        <p class="text-gray-700 text-lg leading-relaxed">{meta.description}</p>
      </div>
    )}

    {images.length > 0 ? (
      <div class="columns-1 md:columns-2 lg:columns-3 gap-6 space-y-6">
        {images.map((img: string, index: number) => (
            <div class="break-inside-avoid group rounded-lg overflow-hidden border border-gray-100 shadow-sm hover:shadow-lg transition-all duration-300 bg-white">
              <a 
                href={fixPath(img)} 
                class="lightbox-trigger block relative overflow-hidden"
                data-index={index}
              >
                <img 
                  src={fixPath(img)} 
                  alt={`${meta.title} photo ${index + 1}`} 
                  class="w-full h-auto block transform group-hover:scale-105 transition-transform duration-500"
                  loading="lazy"
                />
                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100">
                  <span class="text-white bg-black/50 p-2 rounded-full">üîç</span>
                </div>
              </a>
            </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-12 text-gray-500">
        No images found in this folder yet.
      </div>
    )}
  </div>

  <div id="lightbox" class="fixed inset-0 z-[9999] bg-black/95 hidden flex-col items-center justify-center opacity-0 transition-opacity duration-300 touch-none">
    
    <button id="lb-close" class="absolute top-4 right-4 text-white hover:text-red-400 p-4 z-[10001] cursor-pointer bg-black/20 rounded-full backdrop-blur-sm transition-colors" aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <button id="lb-prev" class="absolute left-2 md:left-8 top-1/2 -translate-y-1/2 text-white hover:text-primary bg-black/40 hover:bg-white/10 rounded-full p-3 md:p-4 z-[10001] cursor-pointer backdrop-blur-md border border-white/10 shadow-xl transition-all hover:scale-110" aria-label="Previous Image">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 md:h-10 md:w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7" />
        </svg>
    </button>

    <button id="lb-next" class="absolute right-2 md:right-8 top-1/2 -translate-y-1/2 text-white hover:text-primary bg-black/40 hover:bg-white/10 rounded-full p-3 md:p-4 z-[10001] cursor-pointer backdrop-blur-md border border-white/10 shadow-xl transition-all hover:scale-110" aria-label="Next Image">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 md:h-10 md:w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7" />
        </svg>
    </button>

    <div class="relative w-full h-full p-2 md:p-12 flex items-center justify-center">
        <img id="lb-image" src="" alt="Full size" class="max-w-full max-h-[90vh] object-contain shadow-2xl rounded select-none" />
    </div>

    <div class="absolute bottom-6 left-1/2 -translate-x-1/2 text-white/80 bg-black/40 px-4 py-1 rounded-full text-sm font-medium backdrop-blur-sm z-[10000]">
      <span id="lb-current">1</span> / <span id="lb-total">1</span>
    </div>
  </div>

</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1. SELECT ELEMENTS WITH TYPE ASSERTIONS
    const triggers = document.querySelectorAll('.lightbox-trigger');
    const lightbox = document.getElementById('lightbox') as HTMLElement;
    const lbImage = document.getElementById('lb-image') as HTMLImageElement;
    const lbClose = document.getElementById('lb-close') as HTMLElement;
    const lbPrev = document.getElementById('lb-prev') as HTMLElement;
    const lbNext = document.getElementById('lb-next') as HTMLElement;
    const lbCurrent = document.getElementById('lb-current') as HTMLElement;
    const lbTotal = document.getElementById('lb-total') as HTMLElement;

    // Safety Check
    if (!lightbox || !lbImage || !lbPrev || !lbNext || !lbClose) {
        return;
    }

    let currentIndex = 0;
    const images = Array.from(triggers).map(el => (el as HTMLAnchorElement).href);
    
    if (lbTotal) lbTotal.textContent = images.length.toString();

    // --- NAVIGATION FUNCTIONS ---

    const openLightbox = (index: number) => {
      currentIndex = index;
      updateImage();
      lightbox.classList.remove('hidden');
      setTimeout(() => lightbox.classList.remove('opacity-0'), 10);
      document.body.style.overflow = 'hidden'; 
    };

    const closeLightbox = () => {
      lightbox.classList.add('opacity-0');
      setTimeout(() => {
        lightbox.classList.add('hidden');
        document.body.style.overflow = '';
      }, 300);
    };

    const updateImage = () => {
        lbImage.style.opacity = '0.5';
        setTimeout(() => {
            if (currentIndex >= images.length) currentIndex = 0;
            if (currentIndex < 0) currentIndex = images.length - 1;

            lbImage.src = images[currentIndex];
            if (lbCurrent) lbCurrent.textContent = (currentIndex + 1).toString();
            
            lbImage.onload = () => { lbImage.style.opacity = '1'; };
        }, 150);
    };

    const nextImage = (e?: Event) => {
        if(e) e.stopPropagation();
        currentIndex = (currentIndex + 1) % images.length;
        updateImage();
    };

    const prevImage = (e?: Event) => {
        if(e) e.stopPropagation();
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        updateImage();
    };

    // --- TOUCH / SWIPE LOGIC ---
    let touchStartX = 0;
    let touchEndX = 0;

    lightbox.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    lightbox.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, { passive: true });

    const handleSwipe = () => {
        const threshold = 50; // Minimum distance to count as a swipe
        if (touchEndX < touchStartX - threshold) nextImage(); // Swiped Left -> Next
        if (touchEndX > touchStartX + threshold) prevImage(); // Swiped Right -> Prev
    };

    // --- EVENT LISTENERS ---

    triggers.forEach((trigger, index) => {
      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        openLightbox(index);
      });
    });

    lbNext.addEventListener('click', nextImage);
    lbPrev.addEventListener('click', prevImage);
    lbClose.addEventListener('click', closeLightbox);
    
    // Close on background click (ignoring the image itself)
    lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox || (e.target as HTMLElement).closest('#lightbox > div') === null) {
             if (e.target === lightbox) closeLightbox();
        }
    });

    // Keyboard Support
    document.addEventListener('keydown', (e) => {
        if (lightbox.classList.contains('hidden')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') nextImage();
        if (e.key === 'ArrowLeft') prevImage();
    });
  });
</script>
---
import Layout from '../layouts/Layout.astro';
import ical from 'ical';

// ==========================================
// CONFIGURATION SECTION
// ==========================================

// PASTE YOUR GOOGLE CALENDAR "SECRET ADDRESS IN ICAL FORMAT" HERE:
// (Settings > Integrate Calendar > Secret address in iCal format)
const GOOGLE_ICAL_URL = "https://calendar.google.com/calendar/ical/67aefd4dd7621c22897c0a8fdd47453ee92c5d6d55de02e1b1e5465cfa4a7027%40group.calendar.google.com/public/basic.ics";

// ==========================================
// DATA FETCHING LOGIC (Server Side)
// ==========================================

// 1. Define Fallback Data (Shows if Calendar fetch fails or is empty)
const fallbackEvents = [
  {
    day: "15",
    month: "MAY",
    title: "Spring Cookout (Example)",
    time: "9:00 AM - 4:00 PM",
    location: "Club Flying Field",
    description: "This is a placeholder event because the Google Calendar connection isn't set up yet.",
    linkUrl: "/contact",
    linkText: "Get Directions",
    color: "bg-gray-500"
  }
];

// 2. The Fetching Function
let upcomingEvents = fallbackEvents;
let fetchError = false;

try {
  // Only attempt fetch if the URL has been updated from the placeholder
  if (!GOOGLE_ICAL_URL.includes("YOUR_CALENDAR_ID")) {
    
    const response = await fetch(GOOGLE_ICAL_URL);
    if (!response.ok) throw new Error('Failed to fetch calendar');
    
    const data = await response.text();
    const parsedData = ical.parseICS(data);

    // Process the raw ICS data
    const realEvents = Object.values(parsedData)
      .filter((event) => event.type === 'VEVENT') // Only events, not timezones
      .filter((event) => new Date(event.start) >= new Date()) // Only future events
      .sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime()) // Sort chronological
      .slice(0, 10) // Limit to next 10 events
      .map((event) => {
        const date = new Date(event.start);
        const endDate = new Date(event.end);
        
        // Format Time (e.g. 9:00 AM)
        const timeOpts: Intl.DateTimeFormatOptions = { hour: 'numeric', minute: '2-digit' };
        const timeString = `${date.toLocaleTimeString('en-US', timeOpts)} - ${endDate.toLocaleTimeString('en-US', timeOpts)}`;

        return {
          day: date.getDate(),
          month: date.toLocaleString('default', { month: 'short' }).toUpperCase(),
          title: event.summary,
          time: timeString,
          location: event.location || "Club Flying Field",
          description: event.description || "",
          linkUrl: "#", // Calendar events usually don't have links, but you could map this to a description field URL
          linkText: "Add to Calendar",
          color: "bg-primary" // You could randomize this or base it on event title keywords
        };
      });

    // If we found events, override the fallback
    if (realEvents.length > 0) {
      upcomingEvents = realEvents;
    } else {
        // If calendar is valid but empty, show an empty array (don't show fallback)
        upcomingEvents = [];
    }
  }
} catch (e) {
  console.error("Error fetching Google Calendar:", e);
  fetchError = true;
  // We stick with fallbackEvents here so the page doesn't crash
}

// 3. Regular Activities (Static Data)
const regularActivities = [
  {
    icon: "üå§Ô∏è",
    title: "The Tuesday Group",
    when: "Every Tuesday (Weather Permitting)",
    time: "Morning - Early Afternoon",
    desc: "A dedicated group of members flies almost every Tuesday when the weather is nice. Great time for retirees."
  },
  {
    icon: "üåô",
    title: "Night Flying",
    when: "Twice Monthly",
    time: "Dusk - 10:00 PM",
    desc: "Usually scheduled around the full moon or clear weekends. Check our Facebook group for the 'Go/No-Go' call."
  },
  {
    icon: "üóìÔ∏è",
    title: "Monthly Meeting",
    when: "3rd Monday of the Month",
    time: "7:00 PM",
    desc: "We discuss club business, upcoming projects, and show-and-tell. Held at the Community Center Main Hall."
  },
  {
    icon: "‚úàÔ∏è",
    title: "Open Flying",
    when: "Weekends",
    time: "Dawn - Dusk",
    desc: "The field is busiest on Saturday and Sunday mornings. Come out to see the widest variety of aircraft."
  }
];
---

<Layout title="Events" description="Upcoming events and activities at Macon Aero Modelers">
  
  <div class="bg-gradient-to-br from-primary to-secondary text-white py-16 px-4 rounded-2xl text-center mb-12 shadow-md">
    <h1 class="text-4xl md:text-5xl font-bold mb-4">Events & Activities</h1>
    <p class="text-xl md:text-2xl text-blue-50 max-w-2xl mx-auto">
      Join us for fly-ins, competitions, and club meetings
    </p>
  </div>

  <section class="mb-16">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold text-text-dark">Upcoming Events</h2>
        </div>
    
    <div class="flex flex-col gap-6">
      
      {/* ERROR STATE: If fetch failed and we are using fallback */}
      {fetchError && (
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
          <p class="text-yellow-700 text-sm">
            <strong>Note:</strong> Could not load live calendar. Showing example events.
          </p>
        </div>
      )}

      {/* EVENT CARDS */}
      {upcomingEvents.length > 0 ? (
        upcomingEvents.map((event) => (
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
            <div class="flex flex-col sm:flex-row gap-6">
              
              {/* Date Badge */}
              <div class={`${event.color || 'bg-primary'} text-white rounded-lg p-4 text-center min-w-[100px] h-fit flex flex-col justify-center shrink-0`}>
                <div class="text-3xl font-bold">{event.day}</div>
                <div class="text-sm font-medium tracking-wider">{event.month}</div>
              </div>
              
              {/* Event Details */}
              <div class="flex-grow">
                <h3 class="text-xl font-bold text-primary mb-2">{event.title}</h3>
                <div class="text-gray-600 mb-4 space-y-1">
                  <p><strong>Time:</strong> {event.time}</p>
                  <p><strong>Location:</strong> {event.location}</p>
                </div>
                {event.description && (
                  <p class="text-gray-700 mb-4 leading-relaxed line-clamp-3">
                    {event.description}
                  </p>
                )}
                
                {/* Add to Calendar Button (Generic Link for now) */}
                {/* Only show if it's a real event, not a placeholder */}
                {event.linkUrl !== "#" ? (
                  <a href={event.linkUrl} class="inline-block bg-primary text-white font-medium py-2 px-4 rounded hover:bg-primary-hover transition-colors">
                    {event.linkText}
                  </a>
                ) : (
                  <span class="inline-block bg-gray-100 text-gray-500 font-medium py-2 px-4 rounded cursor-default">
                    Sync from Calendar
                  </span>
                )}
              </div>
            </div>
          </div>
        ))
      ) : (
        /* EMPTY STATE (No events found) */
        <div class="text-center py-12 bg-gray-50 rounded-xl border border-dashed border-gray-300">
          <p class="text-gray-500 text-lg">No special events currently scheduled.</p>
          <p class="text-gray-400">Check our regular schedule below!</p>
        </div>
      )}
    </div>
  </section>

  <section class="mb-16">
    <h2 class="text-3xl font-bold text-text-dark mb-6">Regular Schedule</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {regularActivities.map((activity) => (
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-full flex flex-col">
          <h3 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
            <span class="text-2xl">{activity.icon}</span> {activity.title}
          </h3>
          <div class="space-y-2 text-gray-600 flex-grow">
            <p><strong>When:</strong> {activity.when}</p>
            <p><strong>Time:</strong> {activity.time}</p>
            <p class="text-sm mt-3 border-t pt-3 text-gray-700 leading-relaxed">
                {activity.desc}
            </p>
          </div>
        </div>
      ))}
    </div>
  </section>

  <section class="bg-background-alt rounded-2xl p-8 border border-gray-200">
    <div class="max-w-4xl mx-auto text-center">
      <h2 class="text-2xl font-bold text-text-dark mb-4">Weather Permitting</h2>
      <p class="text-lg text-text-light mb-8">
        RC Flying is strictly weather dependent. For the "Tuesday Group" and Night Flies, check our social media for last-minute Go/No-Go decisions.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="https://www.facebook.com/MaconAeroModelers" target="_blank" class="inline-block bg-white text-secondary border border-secondary font-semibold py-3 px-8 rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
          Check Facebook for Updates
        </a>
      </div>
    </div>
  </section>
</Layout>
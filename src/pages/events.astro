---
import Layout from '../layouts/Layout.astro';
import ical from 'ical';

// ==========================================
// CONFIGURATION
// ==========================================
const GOOGLE_ICAL_URL = "https://calendar.google.com/calendar/ical/67aefd4dd7621c22897c0a8fdd47453ee92c5d6d55de02e1b1e5465cfa4a7027%40group.calendar.google.com/public/basic.ics";

// Define the shape of an event so TypeScript doesn't get confused
interface ClubEvent {
  day: string;
  month: string;
  title: string;
  time: string;
  location: string;
  description: string;
  linkUrl: string;
  linkText: string;
  color: string;
}

// ==========================================
// DATA FETCHING LOGIC
// ==========================================

// 1. Define Fallback Data
const fallbackEvents: ClubEvent[] = [
  {
    day: "15",
    month: "MAY",
    title: "Spring Cookout (Example)",
    time: "9:00 AM - 4:00 PM",
    location: "Club Flying Field",
    description: "This is a placeholder event because the Google Calendar connection isn't set up yet.",
    linkUrl: "/contact",
    linkText: "Get Directions",
    color: "bg-gray-500"
  }
];

// 2. The Fetching Function
let upcomingEvents: ClubEvent[] = fallbackEvents;
let fetchError = false;

try {
  // Only attempt fetch if the URL has been updated from the placeholder
  if (!GOOGLE_ICAL_URL.includes("YOUR_CALENDAR_ID")) {
    
    const response = await fetch(GOOGLE_ICAL_URL);
    if (!response.ok) throw new Error('Failed to fetch calendar');
    
    const data = await response.text();
    const parsedData = ical.parseICS(data);

    // Process the raw ICS data
    const realEvents = Object.values(parsedData)
      .filter((event) => event.type === 'VEVENT') 
      .filter((event) => {
        // Safety check: Ensure start date exists
        return event.start && new Date(event.start) >= new Date();
      }) 
      .sort((a, b) => {
        // Safety check for sorting
        const dateA = a.start ? new Date(a.start).getTime() : 0;
        const dateB = b.start ? new Date(b.start).getTime() : 0;
        return dateA - dateB;
      })
      .slice(0, 10)
      .map((event): ClubEvent => {
        // Force create dates with fallback to current time if missing (unlikely due to filter above)
        const date = event.start ? new Date(event.start) : new Date();
        const endDate = event.end ? new Date(event.end) : new Date();
        
        // Format Time
        const timeOpts: Intl.DateTimeFormatOptions = { 
          hour: 'numeric', 
          minute: '2-digit',
          timeZone: 'America/New_York'
        };
        const timeString = `${date.toLocaleTimeString('en-US', timeOpts)} - ${endDate.toLocaleTimeString('en-US', timeOpts)}`;

        return {
          day: date.toLocaleString('en-US', { day: 'numeric', timeZone: 'America/New_York' }), 
          month: date.toLocaleString('en-US', { month: 'short', timeZone: 'America/New_York' }).toUpperCase(),
          title: event.summary || "Untitled Event", // FIX: Handle undefined title
          time: timeString,
          location: event.location || "Club Flying Field",
          description: event.description || "",
          linkUrl: "#", 
          linkText: "Add to Calendar",
          color: "bg-primary"
        };
      });

    if (realEvents.length > 0) {
      upcomingEvents = realEvents;
    } else {
        upcomingEvents = [];
    }
  }
} catch (e) {
  console.error("Error fetching Google Calendar:", e);
  fetchError = true;
}

// 3. Regular Activities (Static Data)
const regularActivities = [
  {
    icon: "üå§Ô∏è",
    title: "The Tuesday Group",
    when: "Every Tuesday (Weather Permitting)",
    time: "Morning - Early Afternoon",
    desc: "A dedicated group of members flies almost every Tuesday when the weather is nice. Great time for those with flexible schedules."
  },
  {
    icon: "üåô",
    title: "Night Flying",
    when: "Twice Monthly",
    time: "Dusk - 10:00 PM",
    desc: "Usually scheduled on every Saturdays when the weather is cooperating. Experience the thrill of well lit aircraft under the stars."
  },
  {
    icon: "üóìÔ∏è",
    title: "Board Meetings",
    when: "Held Quarterly",
    time: "7:00 PM",
    desc: "We discuss club business, upcoming projects, and show-and-tell. Held at at the field or other local venue."
  },
  {
    icon: "‚úàÔ∏è",
    title: "Open Flying",
    when: "Weekends",
    time: "Dawn - Dusk",
    desc: "When the weather is good, come out to see the wide variety of aircraft."
  }
];
---

<Layout title="Events" description="Upcoming events and activities at Macon Aero Modelers">
  
  <div class="relative bg-gray-900 text-white py-20 px-4 rounded-b-3xl md:rounded-2xl mb-12 shadow-xl overflow-hidden">
    <div class="absolute inset-0 z-0">
      <img 
        src={`${import.meta.env.BASE_URL}assets/images/hero1.jpg`} 
        alt="Club Events" 
        class="w-full h-full object-cover opacity-40" 
      />
      <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent"></div>
    </div>
    
    <div class="relative z-10 text-center max-w-4xl mx-auto mt-4">
      <h1 class="text-4xl md:text-5xl font-bold mb-6 drop-shadow-lg">Events & Activities</h1>
      <p class="text-xl md:text-2xl text-gray-200 max-w-2xl mx-auto drop-shadow-md">
        Join us for fly-ins, competitions, and club meetings.
      </p>
    </div>
  </div>

  <section class="mb-16">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold text-text-dark">Upcoming Events</h2>
    </div>
    
    <div class="flex flex-col gap-6">
      
      {/* ERROR STATE */}
      {fetchError && (
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
          <p class="text-yellow-700 text-sm">
            <strong>Note:</strong> Could not load live calendar. Showing example events.
          </p>
        </div>
      )}

      {/* EVENT CARDS */}
      {upcomingEvents.length > 0 ? (
        upcomingEvents.map((event) => (
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
            <div class="flex flex-col sm:flex-row gap-6">
              
              {/* Date Badge */}
              <div class={`${event.color || 'bg-primary'} text-white rounded-lg p-4 text-center min-w-[100px] h-fit flex flex-col justify-center shrink-0`}>
                <div class="text-3xl font-bold">{event.day}</div>
                <div class="text-sm font-medium tracking-wider">{event.month}</div>
              </div>
              
              {/* Event Details */}
              <div class="flex-grow">
                <h3 class="text-xl font-bold text-primary mb-2">{event.title}</h3>
                <div class="text-gray-600 mb-4 space-y-1">
                  <p><strong>Time:</strong> {event.time}</p>
                  <p><strong>Location:</strong> {event.location}</p>
                </div>
                {event.description && (
                  <p class="text-gray-700 mb-4 leading-relaxed line-clamp-3">
                    {event.description}
                  </p>
                )}
                
                {/* Button */}
                {event.linkUrl !== "#" ? (
                  <a href={event.linkUrl} class="inline-block bg-primary text-white font-medium py-2 px-4 rounded hover:bg-primary-hover transition-colors">
                    {event.linkText}
                  </a>
                ) : (
                  <span class="inline-block bg-gray-100 text-gray-500 font-medium py-2 px-4 rounded cursor-default">
                    Sync from Calendar
                  </span>
                )}
              </div>
            </div>
          </div>
        ))
      ) : (
        /* EMPTY STATE */
        <div class="text-center py-12 bg-gray-50 rounded-xl border border-dashed border-gray-300">
          <p class="text-gray-500 text-lg">No special events currently scheduled.</p>
          <p class="text-gray-400">Check our regular schedule below!</p>
        </div>
      )}
    </div>
  </section>

  <section class="mb-16">
    <h2 class="text-3xl font-bold text-text-dark mb-6">Regular Schedule</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {regularActivities.map((activity) => (
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-full flex flex-col">
          <h3 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
            <span class="text-2xl">{activity.icon}</span> {activity.title}
          </h3>
          <div class="space-y-2 text-gray-600 flex-grow">
            <p><strong>When:</strong> {activity.when}</p>
            <p><strong>Time:</strong> {activity.time}</p>
            <p class="text-sm mt-3 border-t pt-3 text-gray-700 leading-relaxed">
                {activity.desc}
            </p>
          </div>
        </div>
      ))}
    </div>
  </section>

  <section class="bg-background-alt rounded-2xl p-8 border border-gray-200">
    <div class="max-w-4xl mx-auto text-center">
      <h2 class="text-2xl font-bold text-text-dark mb-4">Weather Permitting</h2>
      <p class="text-lg text-text-light mb-8">
        RC Flying is strictly weather dependent. For the "Tuesday Group" and Night Flies, check our Discord for last-minute Go/No-Go decisions.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="https://discord.gg/2KS8RWbumy" target="_blank" class="inline-block bg-white text-secondary border border-secondary font-semibold py-3 px-8 rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
          Check Discord for Updates
        </a>
      </div>
    </div>
  </section>
</Layout>